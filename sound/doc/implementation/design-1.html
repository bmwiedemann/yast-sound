<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>YaST2: Sound configuration: General layout</TITLE>
 <LINK HREF="design-2.html" REL=next>

 <LINK HREF="design.html#toc1" REL=contents>
</HEAD>
<BODY>
<A HREF="design-2.html">Next</A>
Previous
<A HREF="design.html#toc1">Contents</A>
<HR>
<H2><A NAME="s1">1. General layout</A></H2>

<P><I>Note: Currently only alsa sound support is included and only one
sound card can be installed.</I>
<P>
<P>The general procedure of sound configuration consists of
four main steps:
<P>
<OL>
<LI>choosing the sound card (either manual or auto-detected),</LI>
<LI>loading the kernel module (with or without options passed to that
module),</LI>
<LI>adjusting the volume and testing the sound card,</LI>
<LI>saving the configuration.</LI>
</OL>
<P>Thus the code is divided in a similar (main) parts following these
steps. Of course there are some ``abnormal'' branches. There is also
possibility of <B>erasing</B> the previous configuration. The last
two steps are provided only if loading of the kernel module was successful.
<P>
<P>The code is devided into the submodules according to the particular
usage. There are these modules (alphabetical order):
<DL>
<DT><B>sound.ycp</B><DD><P>Main module. From this module all othes submodules
are called in order to provide all the steps mentioned above. The main
part of this module is to display, what was found (even it was already
detected sound card, sound card found by autodetection, ...).
<DT><B> sound_already.ycp</B><DD><P>Module for displaying information about
that there already exists some configured sound card. The
configuration can be deleted in this module.
<DT><B>sound_manual.ycp</B><DD><P>Module that allows choose driver
manually. There is also implemented searching for a sound card.
<DT><B>sound_options.ycp</B><DD><P>Module for adjusting options for a sound
card module.
<DT><B>sound_save.ycp</B><DD><P>Module that saves configuration.
<DT><B>sound_volume.ycp</B><DD><P>Module for adjusting volume. Also when some
error during inserting kernel module occurs it is displayed here.
</DL>
<P>
<P>There is also very important component: <B>sound card database</B>,
which contains especially information about ``which module for which
sound card'' and for each module possible options that can be passed
to that module.
<P>
<H2><A NAME="ss1.1">1.1 Choosing the sound card</A>
</H2>

<P>First of all check if <B>ALSA</B> package is installed is made. Then
the sound card database is read and finally it tries to read (if
exists) already configured sound cards (again just ALSA cards, reading
<CODE>/proc/asound/cards</CODE>).
<P>
<P>The main part is divided into two streams: sound card
<B>auto-detection</B> and <B>manual</B> setup. First one is done
through <I>libhd</I>, exactly by reading <I>SCR</I> path
``.probe.byclass.multimedia.audio''. Second one is done by user input,
by selecting the appropriate card by hand from the database. For both
these possibilities the important thing is, that the right kernel
module is selected from the sound card database.
<P>In both cases the info which is shown to the user is: ``sound card
driver'' and ``sound card model''.
<P>In the case of manual selection, there is also implemented searching
for a particular sound card model .
<P>
<H3>Dialogs</H3>

<P>
<UL>
<LI>
<A HREF="sound-found.jpg">Sound card found</A></LI>
<LI>
<A HREF="sound-manual.jpg">Manual selection</A></LI>
</UL>
<P>
<H2><A NAME="ss1.2">1.2 Loading the kernel module</A>
</H2>

<P>As was mentioned in the previous section in this step is known which
kernel module will be tried (either it was chosen manually or
not). For all <B>ALSA</B> modules there is a possibility to pass
some options to the module (like IRQ, DMA, etc.). So there is a dialog
for setting these options (all the option has their descriptions, as
will be described in the section of <B>sound card database</B>).
<P>
<P>However are the options changed or not, than an attempt for loading
selection kernel module is provided. Success or bad success is found
out by reading and parsing <CODE>/proc/asound/cards</CODE>.
<P>
<H3>Dialogs</H3>

<P>
<UL>
<LI>
<A HREF="sound-options.jpg">Setting options</A></LI>
<LI>
<A HREF="sound-error.jpg">Error loading module</A></LI>
</UL>
<P>
<H2><A NAME="ss1.3">1.3 Adjusting the volume and testing the sound card</A>
</H2>

<P>This step is provided only if the loading of the kernel module was
successful. Volume setting are done by calling external
<B>amixer</B> program (which is part of ALSA package). First the
<I>PCM</I> device is un-mute and than the <I>Master</I> device can
be changed.
<P>
<P>Testing is done by playing some audio (SUN ``au'') file simply by
<CODE>cut</CODE>ting it to <CODE>/dev/audio</CODE>.
<P>
<H3>Dialogs</H3>

<P>
<UL>
<LI>
<A HREF="sound-volume.jpg">Adjusting volume</A></LI>
</UL>
<P>
<H2><A NAME="ss1.4">1.4 Saving the configuration</A>
</H2>

<P>If everything went well and user wants to save the configuration, than
sound volume and sound card configuration are saved. The volume is
stored in <CODE>/etc/asound.conf</CODE> and it is done by calling external
<B>alsactl store</B> command. 
<P>
<P>The configuration (``which module should be started at boot time'') is
saved in <CODE>/etc/modules.conf</CODE>. Currently just one sound card can
be configured by this module, so the saved information is simple. The
part which vary is an alias <CODE>snd-card-0</CODE>, where the selected
module is saved and its options. 
<P>
<H3>Dialogs</H3>

<P>
<UL>
<LI>
<A HREF="sound-config.jpg">Saving configuration</A></LI>
<LI>
<A HREF="sound-success.jpg">Successful configured</A></LI>
</UL>
<P>
<H2><A NAME="ss1.5">1.5 Sound card database</A>
</H2>

<P>This database contains information about all available ALSA kernel
modules. The database is generated by perl script, which runs
<CODE>modinfo</CODE> over all <I>snd-card-*</I> modules. The database is
list of maps, one map for each module, this keys are provided:
<P>
<P>
<DL>
<DT><B>name (<I>string</I>) </B><DD><P>name of the module
<DT><B>module (<I>map</I>) </B><DD><P>two keys ``name'' (string) that contains module
file name, ``modprobe'' (boolean), true if modprobe can be used for
module loading
<DT><B>cards (<I>list</I>) </B><DD><P>list of strings, that are possible sound
card models
<DT><B>libhd (<I>list</I>) </B><DD><P>list of maps with keys ``vendor_id'' (integer),
``device_id'' (integer) that can be return by <B>libhd</B>
<DT><B>params (<I>list</I>) </B><DD><P>list of maps for module parameters, keys
are: ``name'' (string) name of the option, ``type'' (string) type of
the option (i.e. int), ``values'' (string) string for checking
possible values, ``description'' map of strings that can be translated
</DL>
<P>
<P>The database can be localized (strictly speaking options
``description'' can be). The process of creating the database consist
of (possibly) four steps:
<P>
<OL>
<LI>If the file <CODE>sndcards.ycp.generated</CODE> doesn't exists, perl
script <CODE>gendb</CODE> which creates this file is run (this needs ALSA
drivers to be installed), otherwise this is skipped
to next step</LI>
<LI>File <CODE>sndcards.ycp.noloc</CODE> is a simple copy of
<CODE>sndcards.ycp.generated</CODE> (this file contains ``_()'' strings to
translate</LI>
<LI>The strings can be translated now (<CODE>sndcards.pot</CODE> file exists)</LI>
<LI>Running <CODE>printers_localize</CODE> script is made the final
<B>sndcards.ycp</B> file replacing non localized string with localization</LI>
</OL>
<P>Here is a fragment (one module entry) of the database:
<HR>
<PRE>
$[
        "name" : "Ensoniq/Creative AudioPCI ES1371+",
        "module" : 
                $[
                "name" : "snd-card-ens1371",
                "modprobe" : true
        ],
        "cards" : [
                "Sound Blaster PCI64",
                "Sound Blaster PCI128",
                "Sound Blaster Vibra PCI",
                "Ectiva EV1938"
        ],
        "libhd" : [
                $["vendor_id" : 0x1102, 
                  "device_id" : [0x8938]],
                $["vendor_id" : 0x1274, 
                  "device_id" : [0x1371]],
                $["vendor_id" : 0x1274, 
                  "device_id" : [0x5880]]
        ],
        "params" : [
                $[
                "name" : "snd_index",
                "type" : "int",
                "description" : $[ "default" : "Index value for Ensoniq AudioPCI soundcard.", "cs" : "Index pro zvukovou kartu Ensoniq AudioPCI." ]
                ],
                $[
                "name" : "snd_id",
                "type" : "string",
                "description" : $[ "default" : "ID string for Ensoniq AudioPCI soundcard.", "cs" : "ID øetìzec pro zvukovou kartu Ensoniq AudioPCI." ]
                ],
                $[
                "name" : "snd_dac1_frame_size",
                "type" : "int",
                "description" : $[ "default" : "DAC1 frame size in kB for Ensoniq AudioPCI soundcard.", "cs" : "Velikost frame DAC1 v kB pro zvukovou kartu Ensoniq AudioPCI." ]
                ],
                $[
                "name" : "snd_dac2_frame_size",
                "type" : "int",
                "description" : $[ "default" : "DAC2 frame size in kB for Ensoniq AudioPCI soundcard.", "cs" : "Velikost frame DAC2  v kB pro zvukovou kartu Ensoniq AudioPCI." ]
                ],
                $[
                "name" : "snd_adc_frame_size",
                "type" : "int",
                "description" : $[ "default" : "ADC frame size in kB for Ensoniq AudioPCI soundcard.", "cs" : "Velikost frame ADC v kB pro zvukovou kartu Ensoniq AudioPCI." ]
                ]
        ]
],
</PRE>
<HR>
<P>
<HR>
<A HREF="design-2.html">Next</A>
Previous
<A HREF="design.html#toc1">Contents</A>
</BODY>
</HTML>
